package fr.flolec.alpacabot.alpacaapi.httprequests;

import fr.flolec.alpacabot.alpacaapi.httprequests.asset.AssetClass;
import fr.flolec.alpacabot.alpacaapi.httprequests.asset.AssetModel;
import fr.flolec.alpacabot.alpacaapi.httprequests.asset.AssetService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.autoconfigure.web.client.RestClientTest;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.test.web.client.MockRestServiceServer;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import static org.hamcrest.Matchers.startsWith;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.verify;
import static org.springframework.test.web.client.match.MockRestRequestMatchers.*;
import static org.springframework.test.web.client.response.MockRestResponseCreators.withStatus;
import static org.springframework.test.web.client.response.MockRestResponseCreators.withSuccess;

@RestClientTest(AssetService.class)
@ContextConfiguration(classes = {
        RestClientConfiguration.class,
        AssetService.class})
class AssetServiceTest {

    public static final String ASSETS_LIST_RESPONSE_BODY_EXAMPLE = "[{\"id\":\"38f8a0a4-399c-4f5a-8c0d-7435faef70d1\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"USDC/USD\",\"name\":\"USDC/USD pair\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"1.001301692\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0001\"},{\"id\":\"8588af33-3a8e-4a09-bb6c-ba4226dc7aff\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AAVE/USD\",\"name\":\"Aave / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.009433962\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.01\"},{\"id\":\"73adad68-0e0e-45cb-9bcc-66135068cb4d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AAVE/USDC\",\"name\":\"Aave / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.00950209\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"dfb6d1da-427c-42b6-864d-f227af29e2e9\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AAVE/USDT\",\"name\":\"Aave / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.011790923\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.01\"},{\"id\":\"0515189d-1933-4a94-89ce-4e9a24356d58\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AVAX/USD\",\"name\":\"Avalanche / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.026228269\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0005\"},{\"id\":\"b7b73bc2-e3bc-4b37-8fcf-4eac793027ef\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AVAX/USDC\",\"name\":\"Avalanche / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.026191723\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"da3ee262-cfed-4fef-8e63-13f87911704d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"AVAX/USDT\",\"name\":\"Avalanche / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.020445716\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0005\"},{\"id\":\"50960a81-1ec0-45b8-89dc-d6d3ab92f894\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BAT/USD\",\"name\":\"Basic Attention Token / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"4.008257009\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.000025\"},{\"id\":\"72d88488-20b6-4fc2-a670-a8b706c86c4f\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BAT/USDC\",\"name\":\"Basic Attention Token / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"4.003875751\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"c9b6f16b-e88d-439f-bb0b-acecccab3d10\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BCH/BTC\",\"name\":\"Bitcoin Cash / Bitcoin \",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"235.21663452\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.000001\"},{\"id\":\"f0a05db3-5c93-4524-8a32-2f2b8d4f12fc\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BCH/USD\",\"name\":\"Bitcoin Cash / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.002019426\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.025\"},{\"id\":\"9a3baaff-11b0-4428-a63c-f6e3340694e1\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BCH/USDC\",\"name\":\"Bitcoin Cash / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.002030456\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"56272c8a-e888-4549-aa86-1779996f8bb2\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BCH/USDT\",\"name\":\"Bitcoin Cash / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.004233341\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.025\"},{\"id\":\"276e2673-764b-4ab6-a611-caf665ca6340\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BTC/USD\",\"name\":\"Bitcoin  / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000014457\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"1\"},{\"id\":\"e88ec72e-9707-4aac-8e33-86291e5f2b4a\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BTC/USDC\",\"name\":\"Bitcoin / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000014291\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"c150e086-1e75-44e6-9c2c-093bb1e93139\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"BTC/USDT\",\"name\":\"Bitcoin / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000014524\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"1\"},{\"id\":\"0425de77-90d3-4ac9-b914-73423b4e42b8\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"CRV/USD\",\"name\":\"Curve / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"2.00229062\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"dedf4e7b-3d95-4393-ab91-1181f0ed702e\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"CRV/USDC\",\"name\":\"Curve / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"2.009997728\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"03e005f7-4bfc-4616-b1b0-225dd64074fa\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"DOGE/USD\",\"name\":\"Dogecoin / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"5.824111822\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0000005\"},{\"id\":\"7b4c3c70-b54b-4328-85fb-c24bdb45ef45\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"DOGE/USDT\",\"name\":\"Dogecoin / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"11.750743234\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0000005\"},{\"id\":\"764fb9f4-14a1-4c93-bcf9-6a460029143d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"DOT/USD\",\"name\":\"Polkadot / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.135538086\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"ec294909-7421-4bcd-b991-e8de5a67ecab\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"DOT/USDC\",\"name\":\"Polkadot / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.13569994\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"47d0ce51-247b-483b-908a-b62dfbcb957e\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"ETH/BTC\",\"name\":\"Ethereum / Bitcoin \",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"22.341376228\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0000025\"},{\"id\":\"a1733398-6acc-4e92-af24-0d0667f78713\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"ETH/USD\",\"name\":\"Ethereum / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000266186\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.1\"},{\"id\":\"30c8659a-9a9b-42c8-a093-2673ce98f875\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"ETH/USDC\",\"name\":\"Ethereum / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000267279\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"08b74a3d-9046-4e8f-abbc-8af9f4e5cad7\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"ETH/USDT\",\"name\":\"Ethereum / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000260002\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.1\"},{\"id\":\"3e242d92-02c9-42d8-a2a1-e04f8b2f8860\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"GRT/USD\",\"name\":\"The Graph / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"3.059198551\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00005\"},{\"id\":\"b1365689-2b1b-4b84-a263-67d5c622728d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"GRT/USDC\",\"name\":\"The Graph / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"3.064213661\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"fa9b6855-0ed2-44d5-af2a-4aad84e77307\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LINK/BTC\",\"name\":\"Chainlink / Bitcoin \",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"4835.589941972\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00000005\"},{\"id\":\"faf30512-0c0d-4ff8-a7a0-169c747d1e9c\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LINK/USD\",\"name\":\"Chainlink / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.05787037\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0005\"},{\"id\":\"e8e88d77-460f-466b-a076-88b298bed939\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LINK/USDC\",\"name\":\"Chainlink / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.057551638\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"b8c60aea-6346-42d9-a664-4a49405ddb30\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LINK/USDT\",\"name\":\"Chainlink / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.063457413\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0005\"},{\"id\":\"a9897852-02eb-444a-80fa-ff2a2d329643\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LTC/BTC\",\"name\":\"Litecoin / Bitcoin \",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"113.170948112\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00000025\"},{\"id\":\"19c466e7-e8f7-43e0-a8c5-f17ec9f5de8d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LTC/USD\",\"name\":\"Litecoin / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.011776343\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.005\"},{\"id\":\"aa89f7ea-b30a-4ea4-a34c-1f58e7fef13c\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LTC/USDC\",\"name\":\"Litecoin / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.011787865\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"77c6f47f-0939-4b23-b41e-47b4469c4bc8\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"LTC/USDT\",\"name\":\"Litecoin / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.014402995\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.005\"},{\"id\":\"90a83e2d-e574-404b-9344-74130736b71c\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"MKR/USD\",\"name\":\"Maker / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000351517\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.5\"},{\"id\":\"d31cd0b3-852c-435b-a1ea-ace997ce550a\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"MKR/USDC\",\"name\":\"Maker / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.0003581\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"80d871ac-7a59-48b1-b71d-760d5a6876c6\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SHIB/USD\",\"name\":\"Shiba Inu / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"40048.057669203\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00000001\"},{\"id\":\"da533b7e-5b35-45ef-8ba8-4dd5d44978b8\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SHIB/USDC\",\"name\":\"Shiba Inu / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"39952.057530962\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"bce5b2e7-0678-4b81-9607-4a997471fc92\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SHIB/USDT\",\"name\":\"Shib USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":false,\"attributes\":[],\"min_order_size\":\"35248.501938667\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00000001\"},{\"id\":\"ce414735-ba65-43c8-be76-7cb78ed2413d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SUSHI/USD\",\"name\":\"SushiSwap / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.776216719\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0001\"},{\"id\":\"34bfd447-3a3f-4d03-b3f7-3bbbfd57c6ab\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SUSHI/USDC\",\"name\":\"SushiSwap / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.788301604\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"020f162d-9d1f-4ee2-8476-a0c4f592615e\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"SUSHI/USDT\",\"name\":\"SushiSwap / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.994846694\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0001\"},{\"id\":\"35b8e824-e0d2-4546-a9ec-02a8a301139f\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"UNI/BTC\",\"name\":\"Uniswap / Bitcoin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"5787.037037037\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.00000005\"},{\"id\":\"39d2df3b-4273-46a9-956d-c23634be1e38\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"UNI/USD\",\"name\":\"Uniswap / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.092390701\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.001\"},{\"id\":\"84a8d30e-b945-4a76-b163-979dd14aa5e2\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"UNI/USDC\",\"name\":\"Uniswap / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.088581805\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"70ac93c5-7d32-4545-9f58-b03972f185a1\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"UNI/USDT\",\"name\":\"Uniswap / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.159349852\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.001\"},{\"id\":\"541b0d67-c2c7-4135-ac31-ff2aa6c0dd71\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"USDT/USD\",\"name\":\"USD Tether / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"1.001071146\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"0.0001\"},{\"id\":\"684a2cad-85c3-4e09-ac9d-b8893dd1e02f\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"USDT/USDC\",\"name\":\"USD Tether / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.998402555\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"6a521dc8-c56b-4096-bb84-66e0db2d155d\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"XTZ/USD\",\"name\":\"Tezos / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.999000999\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"83932f5b-533e-4c69-876a-a120b0ae01c1\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"XTZ/USDC\",\"name\":\"Tezos / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"1.002013044\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"9e853ba9-1eea-4226-8a39-c9995420e2c9\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"YFI/USD\",\"name\":\"Yearn Finance / US Dollar\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000146845\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"5\"},{\"id\":\"94c9594d-610a-4235-9298-d9a552461a39\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"YFI/USDC\",\"name\":\"Yearn Finance / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.00013687\",\"min_trade_increment\":\"0.000000001\"},{\"id\":\"82bc6fef-5fb6-48b5-a42e-16a5cbf86c60\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"YFI/USDT\",\"name\":\"Yearn Finance / USD Tether\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"0.000140181\",\"min_trade_increment\":\"0.000000001\",\"price_increment\":\"5\"},{\"id\":\"ff2ec3b7-b581-4a5f-8f75-a98a68ed8332\",\"class\":\"crypto\",\"exchange\":\"CRYPTO\",\"symbol\":\"DOGE/USDC\",\"name\":\"Dogecoin / USD Coin\",\"status\":\"active\",\"tradable\":true,\"marginable\":false,\"maintenance_margin_requirement\":100,\"shortable\":false,\"easy_to_borrow\":false,\"fractionable\":true,\"attributes\":[],\"min_order_size\":\"5.894141223\",\"min_trade_increment\":\"0.000000001\"}]\n";

    @Value("${ALPACA_API_ASSETS_URI}")
    private String uri;

    @Autowired
    private AssetService assetService;

    @Autowired
    private MockRestServiceServer mockRestServiceServer;

    @Mock
    private Logger logger;

    @BeforeEach
    void setUp() {
        ReflectionTestUtils.setField(assetService, "logger", logger);
    }

    @Test
    @DisplayName("getAssetsList: nominal -> assets list retrieved & deserialized")
    void getAssetsList_nominal_assetsListRetrievedAndDeserialized() {
        mockRestServiceServer.expect(method(HttpMethod.GET))
                .andExpect(requestTo(startsWith(uri)))
                .andExpect(queryParam("status", "active"))
                .andExpect(queryParam("asset_class", "crypto"))
                .andRespond(withSuccess(ASSETS_LIST_RESPONSE_BODY_EXAMPLE, MediaType.APPLICATION_JSON));

        List<AssetModel> assetsList = assetService.getAssetsList(AssetClass.CRYPTO);

        assertNotNull(assetsList);
        assertEquals(19, assetsList.size());

        AssetModel assetModel = assetsList.get(0);
        assertNotNull(assetModel);
        assertEquals("8588af33-3a8e-4a09-bb6c-ba4226dc7aff", assetModel.getId());
        assertEquals("CRYPTO", assetModel.getExchange());
        assertEquals("AAVE/USD", assetModel.getSymbol());
        assertEquals("Aave / US Dollar", assetModel.getName());
        assertEquals("active", assetModel.getStatus());
        assertEquals(true, assetModel.getTradable());
        assertEquals(true, assetModel.getFractionable());
        assertEquals("0.009433962", assetModel.getMinOrderSize());
        assertEquals("0.000000001", assetModel.getMinTradeIncrement());
        assertEquals("0.01", assetModel.getPriceIncrement());
    }

    @Test
    @DisplayName("getAssetsList: error -> empty list & logged error")
    void getAssetsList_error_emptyListAndLoggedError() {
        mockRestServiceServer.expect(method(HttpMethod.GET))
                .andExpect(requestTo(startsWith(uri)))
                .andExpect(queryParam("status", "active"))
                .andExpect(queryParam("asset_class", "crypto"))
                .andRespond(withStatus(HttpStatus.FORBIDDEN)
                        .body("{\"message\":\"Forbidden\"}")
                        .contentType(MediaType.APPLICATION_JSON));

        List<AssetModel> assetsList = assetService.getAssetsList(AssetClass.CRYPTO);

        assertNotNull(assetsList);
        assertEquals(0, assetsList.size());
        verify(logger).warn("Assets list could not be retrieved: {}", "403 Forbidden: \"{\"message\":\"Forbidden\"}\"");
    }


    @Test
    @DisplayName("selectUSDAssets: list of various assets -> list of USD assets")
    void selectUSDAssets_listOfVariousAssets_listOfUsdAssets() {
        AssetModel assetModel1 = new AssetModel();
        assetModel1.setName("Bitcoin / US Dollar");
        assetModel1.setExchange("CRYPTO");
        AssetModel assetModel2 = new AssetModel();
        assetModel2.setName("Bitcoin / Euro");
        assetModel2.setExchange("CRYPTO");
        AssetModel assetModel3 = new AssetModel();
        assetModel3.setName("Bitcoin / Dollar");
        assetModel3.setExchange("CRYPTO");
        AssetModel assetModel4 = new AssetModel();
        assetModel4.setName("Bitcoin / USD");
        assetModel4.setExchange("CRYPTO");

        List<AssetModel> assetModels = new ArrayList<>(Arrays.asList(assetModel1, assetModel2, assetModel3, assetModel4));

        assetService.selectUSDAssets(assetModels);

        assertEquals(1, assetModels.size());
        assertTrue(assetModels.contains(assetModel1));
    }

    @Test
    @DisplayName("selectTradableAssets: list of various assets -> list of tradable assets")
    void selectTradableAssets_listOfVariousAssets_listOfTradableAssets() {
        AssetModel assetModel1 = new AssetModel();
        assetModel1.setTradable(true);
        AssetModel assetModel2 = new AssetModel();
        assetModel2.setTradable(false);
        AssetModel assetModel3 = new AssetModel();
        assetModel3.setTradable(true);
        AssetModel assetModel4 = new AssetModel();
        assetModel4.setTradable(false);

        List<AssetModel> assetModels = new ArrayList<>(Arrays.asList(assetModel1, assetModel2, assetModel3, assetModel4));

        assetService.selectTradableAssets(assetModels);

        assertEquals(2, assetModels.size());
        assertTrue(assetModels.contains(assetModel1));
        assertTrue(assetModels.contains(assetModel3));
    }

}